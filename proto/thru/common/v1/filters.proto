syntax = "proto3";

package thru.common.v1;

import "buf/validate/validate.proto";
import "google/api/field_behavior.proto";
import "thru/common/v1/primitives.proto";

option go_package = "github.com/Unto-Labs/thru-net/grpc/pkg/proto/thru/common/v1;commonv1";
option java_multiple_files = true;
option java_package = "network.thru.common.v1";
option csharp_namespace = "Thru.Common.V1";
option ruby_package = "Thru::Common::V1";
option objc_class_prefix = "THU";
option swift_prefix = "THU";

// Filter represents a CEL-based expression applied to query or stream results.
message Filter {
  // CEL expression applied server-side. Empty expressions are treated as no-op.
  optional string expression = 1 [
    (google.api.field_behavior) = OPTIONAL,
    (buf.validate.field).string.max_len = 4096
  ];

  // Named parameter bindings for expression parameterization.
  map<string, FilterParamValue> params = 2
      [(google.api.field_behavior) = OPTIONAL];
}

// FilterParamValue carries strongly-typed CEL parameter bindings.
message FilterParamValue {
  oneof kind {
    string string_value = 1 [(google.api.field_behavior) = OPTIONAL];
    bytes bytes_value = 2 [(google.api.field_behavior) = OPTIONAL];
    bool bool_value = 3 [(google.api.field_behavior) = OPTIONAL];
    sint64 int_value = 4 [(google.api.field_behavior) = OPTIONAL];
    uint64 uint_value = 5 [(google.api.field_behavior) = OPTIONAL];
    double double_value = 6 [(google.api.field_behavior) = OPTIONAL];
    Pubkey pubkey_value = 7 [(google.api.field_behavior) = OPTIONAL];
    Signature signature_value = 8 [(google.api.field_behavior) = OPTIONAL];
    TaPubkey ta_pubkey_value = 9 [(google.api.field_behavior) = OPTIONAL];
    TsSignature ts_signature_value = 10 [(google.api.field_behavior) = OPTIONAL];
    BytesList bytes_list_value = 11 [(google.api.field_behavior) = OPTIONAL];
    PubkeyList pubkey_list_value = 12 [(google.api.field_behavior) = OPTIONAL];
  }
}

// BytesList holds a list of byte arrays for multi-value CEL filtering.
message BytesList {
  repeated bytes values = 1 [(google.api.field_behavior) = OPTIONAL];
}

// PubkeyList holds a list of pubkeys for multi-value CEL filtering.
message PubkeyList {
  repeated Pubkey values = 1 [(google.api.field_behavior) = OPTIONAL];
}

// CelFilterValidation describes the validation configuration returned to
// clients to help them build safe filter expressions.
message CelFilterValidation {
  // List of allowed CEL function names for a specific request type.
  repeated string allowed_functions = 1 [
    (google.api.field_behavior) = OPTIONAL,
    (buf.validate.field).repeated.max_items = 128
  ];

  // List of allowed field names accessible to the CEL expression.
  repeated string allowed_fields = 2 [
    (google.api.field_behavior) = OPTIONAL,
    (buf.validate.field).repeated.max_items = 256
  ];

  // Maximum AST node count permitted for a CEL expression.
  optional uint32 max_complexity = 3 [
    (google.api.field_behavior) = OPTIONAL,
    (buf.validate.field).uint32.lte = 1000
  ];
}
