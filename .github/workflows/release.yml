name: Build Release Artifacts

on:
  release:
    types: [published]

permissions:
  contents: write
  actions: read

jobs:
  # Build SDK artifacts
  build-sdk-artifacts:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      matrix:
        sdk: [c]

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        submodules: true

    - name: Create SDK artifact directory
      run: |
        mkdir -p sdk-artifact/thru-program-sdk-${{ matrix.sdk }}-${{ github.event.release.tag_name }}

    - name: Copy SDK-specific files
      run: |
        # Copy the entire SDK directory
        cp -rL sdks/${{ matrix.sdk }}/. sdk-artifact/thru-program-sdk-${{ matrix.sdk }}-${{ github.event.release.tag_name }}/

        # Ensure deps.sh and setup.sh are executable
        chmod +x sdk-artifact/thru-program-sdk-${{ matrix.sdk }}-${{ github.event.release.tag_name }}/deps.sh
        chmod +x sdk-artifact/thru-program-sdk-${{ matrix.sdk }}-${{ github.event.release.tag_name }}/setup.sh

    - name: Create tarball
      run: |
        cd sdk-artifact
        tar -czf thru-program-sdk-${{ matrix.sdk }}-${{ github.event.release.tag_name }}.tar.gz thru-program-sdk-${{ matrix.sdk }}-${{ github.event.release.tag_name }}/
        cd ..
        mv sdk-artifact/thru-program-sdk-${{ matrix.sdk }}-${{ github.event.release.tag_name }}.tar.gz .

    - name: Create zip archive
      run: |
        cd sdk-artifact
        zip -r thru-program-sdk-${{ matrix.sdk }}-${{ github.event.release.tag_name }}.zip thru-program-sdk-${{ matrix.sdk }}-${{ github.event.release.tag_name }}/
        cd ..
        mv sdk-artifact/thru-program-sdk-${{ matrix.sdk }}-${{ github.event.release.tag_name }}.zip .

    - name: Upload SDK artifacts
      uses: actions/upload-artifact@v5
      with:
        name: sdk-${{ matrix.sdk }}
        path: |
          thru-program-sdk-${{ matrix.sdk }}-${{ github.event.release.tag_name }}.tar.gz
          thru-program-sdk-${{ matrix.sdk }}-${{ github.event.release.tag_name }}.zip
        retention-days: 90

  # Build toolchain for Linux and macOS
  build-toolchain:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-large, macos-15-large]
        include:
          - os: ubuntu-large
            arch: x86_64
          - os: macos-15-large
            arch: arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        submodules: true

    - name: Cache .thru toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: .thru/sdk/toolchain/
        key: thru-toolchain-c-${{ runner.os }}-${{ hashFiles('sdks/deps.sh') }}
        restore-keys: |
          thru-toolchain-c-${{ runner.os }}-

    - name: Update apt (Ubuntu only)
      if: ${{ matrix.os == 'ubuntu-large' }}
      run: |
        sudo apt-get update -y

    - name: Build toolchain dependencies
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        TN_AUTO_INSTALL_PACKAGES=1 ./sdks/deps.sh --thru-dir ${GITHUB_WORKSPACE} fetch check install-c
        rm -rf ${GITHUB_WORKSPACE}/.thru/sdk/toolchain/git

    - name: Verify toolchain installation
      run: |
        echo "${GITHUB_WORKSPACE}/.thru/sdk/toolchain/bin" >> $GITHUB_PATH
        which riscv64-unknown-elf-gcc || echo "Toolchain not in PATH"
        riscv64-unknown-elf-gcc --version || echo "Failed to run gcc"
        riscv64-unknown-elf-g++ --version || echo "Failed to run g++"

    - name: Create minimal toolchain package
      run: |
        cd ${GITHUB_WORKSPACE}/.thru/sdk/

        # Detect OS and architecture
        OS_NAME=$(uname -s)
        ARCH_NAME=$(uname -m)

        # Create a minimal toolchain directory with the final archive name
        mkdir -p thru-toolchain-${OS_NAME}-${ARCH_NAME}-${{ github.event.release.tag_name }}

        # Copy only the essential directories
        for dir in bin include lib libexec picolibc riscv64-unknown-elf share; do
          if [ -d "toolchain/$dir" ]; then
            echo "Copying toolchain/$dir..."
            cp -r "toolchain/$dir" thru-toolchain-${OS_NAME}-${ARCH_NAME}-${{ github.event.release.tag_name }}/
          else
            echo "Warning: toolchain/$dir not found, skipping"
          fi
        done

        # Display what we're packaging
        echo "Toolchain package contents:"
        ls -la thru-toolchain-${OS_NAME}-${ARCH_NAME}-${{ github.event.release.tag_name }}/
        echo "Total size:"
        du -sh thru-toolchain-${OS_NAME}-${ARCH_NAME}-${{ github.event.release.tag_name }}/

    - name: Package toolchain as tar.gz
      run: |
        cd ${GITHUB_WORKSPACE}/.thru/sdk/
        OS_NAME=$(uname -s)
        ARCH_NAME=$(uname -m)
        tar -czf thru-toolchain-${OS_NAME}-${ARCH_NAME}-${{ github.event.release.tag_name }}.tar.gz thru-toolchain-${OS_NAME}-${ARCH_NAME}-${{ github.event.release.tag_name }}/
        ls -la thru-toolchain-${OS_NAME}-${ARCH_NAME}-${{ github.event.release.tag_name }}.tar.gz

    - name: Package toolchain as zip
      run: |
        cd ${GITHUB_WORKSPACE}/.thru/sdk/
        OS_NAME=$(uname -s)
        ARCH_NAME=$(uname -m)
        zip -r thru-toolchain-${OS_NAME}-${ARCH_NAME}-${{ github.event.release.tag_name }}.zip thru-toolchain-${OS_NAME}-${ARCH_NAME}-${{ github.event.release.tag_name }}/
        ls -la thru-toolchain-${OS_NAME}-${ARCH_NAME}-${{ github.event.release.tag_name }}.zip

    - name: Upload toolchain artifacts
      run: |
        OS_NAME=$(uname -s)
        ARCH_NAME=$(uname -m)
        echo "os_name=${OS_NAME}" >> $GITHUB_OUTPUT
        echo "arch_name=${ARCH_NAME}" >> $GITHUB_OUTPUT
      id: detect-platform

    - name: Upload toolchain artifacts to workflow
      uses: actions/upload-artifact@v5
      with:
        name: toolchain-${{ steps.detect-platform.outputs.os_name }}-${{ steps.detect-platform.outputs.arch_name }}
        path: |
          .thru/sdk/thru-toolchain-${{ steps.detect-platform.outputs.os_name }}-${{ steps.detect-platform.outputs.arch_name }}-${{ github.event.release.tag_name }}.tar.gz
          .thru/sdk/thru-toolchain-${{ steps.detect-platform.outputs.os_name }}-${{ steps.detect-platform.outputs.arch_name }}-${{ github.event.release.tag_name }}.zip
        retention-days: 90

  # Upload all artifacts to existing release
  upload-release-artifacts:
    needs: [build-sdk-artifacts, build-toolchain]
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Download all artifacts
      uses: actions/download-artifact@v6
      with:
        path: release-artifacts

    - name: Display downloaded artifacts
      run: |
        echo "Downloaded artifacts:"
        find release-artifacts -type f

    - name: Upload C SDK tar.gz
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./release-artifacts/sdk-c/thru-program-sdk-c-${{ github.event.release.tag_name }}.tar.gz
        asset_name: thru-program-sdk-c-${{ github.event.release.tag_name }}.tar.gz
        asset_content_type: application/gzip

    - name: Upload C SDK zip
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./release-artifacts/sdk-c/thru-program-sdk-c-${{ github.event.release.tag_name }}.zip
        asset_name: thru-program-sdk-c-${{ github.event.release.tag_name }}.zip
        asset_content_type: application/zip

    - name: Upload Toolchain artifacts
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Find all toolchain artifacts and upload them
        for artifact_dir in release-artifacts/toolchain-*; do
          if [ -d "$artifact_dir" ]; then
            echo "Processing $artifact_dir"
            for file in "$artifact_dir"/*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "Uploading $filename"

                # Determine content type
                if [[ "$filename" == *.tar.gz ]]; then
                  content_type="application/gzip"
                elif [[ "$filename" == *.zip ]]; then
                  content_type="application/zip"
                else
                  content_type="application/octet-stream"
                fi

                # Upload using GitHub CLI
                gh release upload "${{ github.event.release.tag_name }}" "$file" --repo "${{ github.repository }}" --clobber
              fi
            done
          fi
        done

    - name: Release Summary
      run: |
        echo "âœ… Successfully uploaded artifacts to release ${{ github.event.release.tag_name }}!"
        echo ""
        echo "Uploaded artifacts:"
        echo "- C SDK (tar.gz, zip)"
        echo "- Toolchains for detected platforms (tar.gz, zip)"
        echo ""
        echo "Toolchain artifacts:"
        find release-artifacts/toolchain-* -type f -exec basename {} \; 2>/dev/null | sort || echo "  No toolchain artifacts found"
