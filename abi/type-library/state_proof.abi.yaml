abi:
  package: "thru.blockchain.state_proof"
  abi-version: 1
  package-version: "1.0.0"
  description: "State proof structures for Merkle tree verification"
  imports:
    - "thru_primitives.abi.yaml"

types:
  - name: "StateProofHeader"
    kind:
      struct:
        packed: true
        fields:
          - name: "type_slot"
            field-type:
              primitive: u64
          - name: "path_bitset"
            field-type:
              type-ref:
                name: "Hash"
                package: "thru.common.primitives"
  - name: "StateProof"
    kind:
      struct:
        packed: true
        fields:
          - name: "hdr"
            field-type:
              type-ref:
                name: "StateProofHeader"
          - name: "proof_body"
            field-type:
              enum:
                packed: true
                tag-ref:
                  bit-and:
                    left:
                      right-shift:
                        left:
                          field-ref:
                            path: ["hdr", "type_slot"]
                        right:
                          literal:
                            u8: 62
                    right:
                      literal:
                        u8: 3
                variants:
                  - name: "existing"
                    tag-value: 0
                    variant-type:
                      struct:
                        packed: true
                        fields:
                          - name: "sibling_hashes"
                            field-type:
                              array:
                                size:
                                  add:
                                    left:
                                      add:
                                        left:
                                          popcount:
                                            operand:
                                              field-ref:
                                                path: ["hdr", "path_bitset", "bytes", 0]
                                        right:
                                          popcount:
                                            operand:
                                              field-ref:
                                                path: ["hdr", "path_bitset", "bytes", 1]
                                    right:
                                      add:
                                        left:
                                          popcount:
                                            operand:
                                              field-ref:
                                                path: ["hdr", "path_bitset", "bytes", 2]
                                        right:
                                          popcount:
                                            operand:
                                              field-ref:
                                                path: ["hdr", "path_bitset", "bytes", 3]
                                element-type:
                                  type-ref:
                                    name: "Hash"
                                    package: "thru.common.primitives"
                  - name: "updating"
                    tag-value: 1
                    variant-type:
                      struct:
                        packed: true
                        fields:
                          - name: "existing_leaf_hash"
                            field-type:
                              type-ref:
                                name: "Hash"
                                package: "thru.common.primitives"
                          - name: "sibling_hashes"
                            field-type:
                              array:
                                size:
                                  add:
                                    left:
                                      add:
                                        left:
                                          popcount:
                                            operand:
                                              field-ref:
                                                path: ["hdr", "path_bitset", "bytes", 0]
                                        right:
                                          popcount:
                                            operand:
                                              field-ref:
                                                path: ["hdr", "path_bitset", "bytes", 1]
                                    right:
                                      add:
                                        left:
                                          popcount:
                                            operand:
                                              field-ref:
                                                path: ["hdr", "path_bitset", "bytes", 2]
                                        right:
                                          popcount:
                                            operand:
                                              field-ref:
                                                path: ["hdr", "path_bitset", "bytes", 3]
                                element-type:
                                  type-ref:
                                    name: "Hash"
                                    package: "thru.common.primitives"
                  - name: "creation"
                    tag-value: 2
                    variant-type:
                      struct:
                        packed: true
                        fields:
                          - name: "existing_leaf_pubkey"
                            field-type:
                              type-ref:
                                name: "Pubkey"
                                package: "thru.common.primitives"
                          - name: "existing_leaf_hash"
                            field-type:
                              type-ref:
                                name: "Hash"
                                package: "thru.common.primitives"
                          - name: "sibling_hashes"
                            field-type:
                              array:
                                size:
                                  add:
                                    left:
                                      add:
                                        left:
                                          popcount:
                                            operand:
                                              field-ref:
                                                path: ["hdr", "path_bitset", "bytes", 0]
                                        right:
                                          popcount:
                                            operand:
                                              field-ref:
                                                path: ["hdr", "path_bitset", "bytes", 1]
                                    right:
                                      add:
                                        left:
                                          popcount:
                                            operand:
                                              field-ref:
                                                path: ["hdr", "path_bitset", "bytes", 2]
                                        right:
                                          popcount:
                                            operand:
                                              field-ref:
                                                path: ["hdr", "path_bitset", "bytes", 3]
                                element-type:
                                  type-ref:
                                    name: "Hash"
                                    package: "thru.common.primitives"
